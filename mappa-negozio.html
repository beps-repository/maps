<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Punto Vendita</title>
    
    <!-- Leaflet e MapTiler -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { 
            width: 100%;
            height: 500px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0px !important;
        }    

        .leaflet-attribution-flag {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // ðŸ”¹ Protezione: accesso solo da beps.it
        if (document.referrer.indexOf("www.beps.it") === -1) {
            document.body.innerHTML = "<h1>Accesso Negato</h1>";
        }

        // ðŸ”¹ Chiavi API
        const MAPTILER_KEY = "VKBAXYVsDcZWpCqYKK8W"; // Chiave API di MapTiler
        const SHEETS_API_KEY = "AIzaSyDc3ctCypDqv7bNDYyeU-A9NfJlztKEdq0";  // Chiave API di Google Sheets
        const SHEET_ID = "1RQxEK4agpUueN2JY1von9cxE-81OBxvT6CA8QO4rcbQT";  // ID del Google Sheet
        const RANGE = "Foglio1!A:AS"; // Range dei dati nel foglio

        // ðŸ”¹ Recupera lo store_id dall'URL
        function getStoreIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("store_id");
        }

        // ðŸ”¹ Ottiene i dati dal Google Sheet
        async function fetchStoreData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${SHEETS_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values;  // Restituisce tutte le righe del foglio
        }

        // ðŸ”¹ Cerca il negozio corrispondente allo store_id
        async function fetchStoreLocation(storeId) {
            const stores = await fetchStoreData();
            const header = stores[0];  // Intestazioni delle colonne

            // Trova gli indici delle colonne nel foglio
            const codAmastyIndex = header.indexOf("cod. amasty");
            const latIndex = header.indexOf("latitudine");
            const lngIndex = header.indexOf("longitudine");
            const nameIndex = header.indexOf("nome negozio");

            if (codAmastyIndex === -1 || latIndex === -1 || lngIndex === -1) {
                console.error("Colonne mancanti nel Google Sheet.");
                return null;
            }

            // Cerca la riga corrispondente allo store_id
            const storeData = stores.find(row => row[codAmastyIndex] === storeId);

            if (storeData) {
                return {
                    lat: parseFloat(storeData[latIndex]),
                    lng: parseFloat(storeData[lngIndex]),
                    name: storeData[nameIndex] || "Punto Vendita"
                };
            }
            return null;
        }

        // ðŸ”¹ Inizializza la mappa
        async function initMap() {
            const storeId = getStoreIdFromURL();

            if (!storeId) {
                console.error("Nessun store_id ricevuto");
                return;
            }

            const store = await fetchStoreLocation(storeId);

            if (!store) {
                console.error("Punto vendita non trovato nel Google Sheet.");
                return;
            }

            const map = L.map("map").setView([store.lat, store.lng], 14);

            // ðŸ”¹ Stile della mappa MapTiler
            L.tileLayer(`https://api.maptiler.com/maps/bright-v2/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`, {
                attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
            }).addTo(map);

            // ðŸ”¹ Stile del marker (logo Beps)
            const customIcon = L.icon({
                iconUrl: "https://www.beps.it/pub/media/beps/Logo_48x48.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            L.marker([store.lat, store.lng], { icon: customIcon }).addTo(map)
                .bindPopup(`<b>${store.name}</b>`)
                .openPopup();
        }

        initMap();
    </script>

</body>
</html>
