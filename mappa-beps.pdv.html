<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mappa con Cluster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .custom-cluster {
            background: #e10b17;
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .custom-marker img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Funzione per caricare dati da Google Sheets in formato CSV
        async function fetchStoreData() {
            const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vS7QO8J4FXkewV74Gp5tBQp2DnOT8e5-ITUOLDBF7NzlYXCQYjHkGmT4-QN25tqH7EEuCQTBsfkzhse/pub?gid=0&single=true&output=csv");
            const csvText = await response.text();

            // Converte il CSV in un array di oggetti
            const rows = csvText.split("\n").slice(1); // Salta l'intestazione
            return rows
                .map(row => {
                    const cols = row.split(",");
                    return {
                        name: cols[5].trim(), // Colonna "F"
                        lat: parseFloat(cols[38].trim()), // Colonna "AM"
                        lng: parseFloat(cols[39].trim()), // Colonna "AN"
                        link: cols[33].trim(), // Colonna "AH"
                        include: cols[40].trim().toLowerCase() === "si" // Colonna "AO"
                    };
                })
                .filter(store => store.include); // Filtra solo i negozi con "si"
        }

        // Inizializza la mappa
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Aggiungi i marker dinamicamente
        async function loadMarkers() {
            const stores = await fetchStoreData();
            const markers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class='custom-cluster'>${count}</div>`,
                        className: 'custom-cluster',
                        iconSize: [45, 45]
                    });
                }
            });

            const markerArray = [];
            stores.forEach(store => {
                const customIcon = L.icon({
                    iconUrl: "https://www.beps.it/pub/media/beps/Logo_48x48.png",
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40]
                });
                const marker = L.marker([store.lat, store.lng], { icon: customIcon })
                    .bindPopup(`<b>${store.name}</b><br><a href="${store.link}" target="_blank">Scopri di pi√π</a>`);
                markers.addLayer(marker);
                markerArray.push(marker);
            });

            map.addLayer(markers);

            // Calcola il bounding box per centrare la mappa
            const group = L.featureGroup(markerArray);
            map.fitBounds(group.getBounds());
        }

        loadMarkers();
    </script>
</body>
</html>
