<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mappa con Cluster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .custom-cluster {
            background: #e10b17;
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .custom-marker img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Funzione per tracciare eventi GA4
        function trackGA4Click(store, region) {
            const sendEvent = () => {
                window.dataLayer.push({
                    event: "store_locator",
                    category: "store_select",
                    action: region,
                    label: store
                });
                console.log("Evento GA4 inviato:", { store, region });
            };

            if (typeof window.dataLayer !== "undefined") {
                sendEvent(); // Esegui subito se dataLayer è disponibile
            } else {
                // Attendi fino a quando dataLayer non diventa disponibile
                const interval = setInterval(() => {
                    if (typeof window.dataLayer !== "undefined") {
                        sendEvent();
                        clearInterval(interval); // Interrompi il controllo
                    }
                }, 100); // Controlla ogni 100 ms
            }
        }

        // Funzione per parsare CSV con gestione delle virgole nei campi
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split("\n");

            lines.forEach((line) => {
                const regex = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;
                const row = [];
                let match;
                while ((match = regex.exec(line)) !== null) {
                    row.push(match[1] || match[2]);
                }
                rows.push(row);
            });

            return rows;
        }

        // Funzione per caricare dati dal CSV remoto
        async function fetchStoreData() {
            const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vS7QO8J4FXkewV74Gp5tBQp2DnOT8e5-ITUOLDBF7NzlYXCQYjHkGmT4-QN25tqH7EEuCQTBsfkzhse/pub?gid=0&single=true&output=csv");
            const csvText = await response.text();

            console.log("CSV Text:", csvText);

            const rows = parseCSV(csvText);
            console.log("Parsed Rows:", rows);

            return rows
                .slice(1) // Salta l'intestazione
                .map((cols) => ({
                    name: cols[5]?.trim() || "Sconosciuto", // Colonna "F"
                    region: cols[42]?.trim() || "Sconosciuto", // Colonna "AQ"
                    lat: parseFloat(cols[38]?.trim() || "0"), // Colonna "AM"
                    lng: parseFloat(cols[39]?.trim() || "0"), // Colonna "AN"
                    link: cols[41]?.trim() || "#", // Colonna "AP"
                    include: cols[40]?.trim() === "1" // Colonna "AO" (1 per pubblicare, 0 per non pubblicare)
                }))
                .filter(store => {
                    const isValid = store.include && !isNaN(store.lat) && !isNaN(store.lng);
                    if (!isValid) {
                        console.warn("Dati non validi:", store);
                    }
                    return isValid;
                });
        }

        // Inizializza la mappa
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Aggiungi i marker dinamicamente
        async function loadMarkers() {
            const stores = await fetchStoreData();
            console.log("Negozi caricati:", stores);

            const markers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class='custom-cluster'>${count}</div>`,
                        className: 'custom-cluster',
                        iconSize: [45, 45]
                    });
                }
            });

            const customIcon = L.icon({
                iconUrl: "https://www.beps.it/pub/media/beps/Logo_48x48.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            const markerArray = [];
            stores.forEach(store => {
                const sanitizedStoreName = store.name.replace(/'/g, "\\'");
                const sanitizedRegion = store.region.replace(/'/g, "\\'");

                const marker = L.marker([store.lat, store.lng], { icon: customIcon })
                    .bindPopup(
                        `<b>${store.name}</b><br>Regione: ${store.region}<br>` +
                        `<a href="${store.link}" target="_blank" onclick="trackGA4Click('${sanitizedStoreName}', '${sanitizedRegion}')">Scopri di più</a>`
                    )
                    .on('click', () => trackGA4Click(store.name, store.region));
                markers.addLayer(marker);
                markerArray.push(marker);
            });

            map.addLayer(markers);

            // Calcola il bounding box per centrare la mappa
            if (markerArray.length > 0) {
                const group = L.featureGroup(markerArray);
                map.fitBounds(group.getBounds());
            } else {
                console.warn("Nessun marker valido trovato. La mappa utilizzerà un centro e uno zoom di default.");
                map.setView([45.4642, 9.1900], 6); // Centro e zoom di default
            }
        }

        loadMarkers();
    </script>
</body>
</html>
