<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mappa con Cluster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .custom-cluster {
            background: #e10b17;
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .custom-marker img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Funzione per caricare dati da Google Sheets
        async function fetchStoreData() {
            const response = await fetch("https://spreadsheets.google.com/feeds/list/1RQxEK4agpUueN2JY1von9cxE-81OBxvT6CA8QO4rcbQ/1/public/values?alt=json");
            const data = await response.json();

            // Estrai i dati dai campi di Google Sheets
            return data.feed.entry
                .filter(entry => entry.gsx$ao.$t.toLowerCase() === "si") // Filtro per "si" nella colonna AO
                .map(entry => ({
                    name: entry.gsx$f.$t,
                    lat: parseFloat(entry.gsx$am.$t),
                    lng: parseFloat(entry.gsx$an.$t),
                    link: entry.gsx$ah.$t
                }));
        }

        // Inizializza la mappa
        const map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Aggiungi i marker dinamicamente
        async function loadMarkers() {
            const stores = await fetchStoreData();
            const markers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class='custom-cluster'>${count}</div>`,
                        className: 'custom-cluster',
                        iconSize: [45, 45]
                    });
                }
            });

            const markerArray = [];
            stores.forEach(store => {
                const customIcon = L.icon({
                    iconUrl: "https://www.beps.it/pub/media/beps/Logo_48x48.png",
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40]
                });
                const marker = L.marker([store.lat, store.lng], { icon: customIcon })
                    .bindPopup(`<b>${store.name}</b><br><a href="${store.link}" target="_blank">Scopri di pi√π</a>`);
                markers.addLayer(marker);
                markerArray.push(marker);
            });

            map.addLayer(markers);

            // Calcola il bounding box per centrare la mappa
            const group = L.featureGroup(markerArray);
            map.fitBounds(group.getBounds());
        }

        loadMarkers();
    </script>
</body>
</html>
