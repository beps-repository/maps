<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mappa con Cluster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 600px;
        }
        .custom-cluster {
            background: #e10b17;
            color: white;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .custom-marker img {
            width: 40px;
            height: 40px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Aggiungi il resto del codice qui (fetchStoreData, parseCSV, loadMarkers, ecc.)
        async function loadMarkers() {
            const stores = await fetchStoreData();
            console.log("Negozi caricati:", stores);

            const markers = L.markerClusterGroup({
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class='custom-cluster'>${count}</div>`,
                        className: 'custom-cluster',
                        iconSize: [45, 45]
                    });
                }
            });

            const customIcon = L.icon({
                iconUrl: "https://www.beps.it/pub/media/beps/Logo_48x48.png",
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });

            stores.forEach(store => {
                const sanitizedStoreName = encodeURIComponent(store.name);
                const sanitizedRegion = encodeURIComponent(store.region);

                const marker = L.marker([store.lat, store.lng], { icon: customIcon })
                    .bindPopup(
                        `<b>${store.name}</b><br>Regione: ${store.region}<br>` +
                        `<a href="${store.link}" target="_blank" onclick="trackGA4Click('${sanitizedStoreName}', '${sanitizedRegion}')">Scopri di più</a>`
                    )
                    .on('click', () => trackGA4Click(store.name, store.region));
                markers.addLayer(marker);
            });

            map.addLayer(markers);

            if (stores.length > 0) {
                const group = L.featureGroup(stores.map(store => L.marker([store.lat, store.lng])));
                map.fitBounds(group.getBounds());
            } else {
                console.warn("Nessun marker valido trovato. La mappa utilizzerà un centro e uno zoom di default.");
                map.setView([45.4642, 9.1900], 6); // Centro e zoom di default
            }
        }

        loadMarkers();
    </script>
</body>
</html>
